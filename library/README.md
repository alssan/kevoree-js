# Kevoree Library

## Create your own Kevoree-JS component

### Step 1
First of all, you need to set up your environment in order to use all the tools provided by Kevoree.

```sh
mkdir kevoree-comp-fakeconsole
cd $_
```

Let start with a fresh new folder. We will name it `kevoree-comp-fakeconsole` just to follow the naming convention __kevoree-TYPE-NAME__. So, we are going to create a new Kevoree component which name is __fakeconsole__.  
The purpose of this component will be to display incoming messages (received from its input port) in a list, and allow users to enter messages in a field and send them to whoever is connected to its ouput port.  

##### If you already have __node__ and __npm__ installed, you can directly go to __Step 2__
If you don't have node, nor npm, you should get it from NodeJS official website (npm is now bundled with node):  
 
 * [NodeJS website](http://nodejs.org/download/)
 
Now you should be able to do:
```sh
$ node --version
v0.10.20
```

```sh
$ npm --version
1.3.11
```

Yay, let's go!


### Step 2
Now that you have `npm` you can install [`yo`](http://yeoman.io)
```sh
npm install -g yo
```
Yeoman ( `yo` ) is a tool that automates project scaffolding. We have created a Yeoman generator for Kevoree that handles all the boring stuffs related to project creation (decent folder tree, well-formed package.json file, kevoree related dependencies, etc.)  
```sh
npm install -g generator-kevoree
```
Now you have Kevoree's yo generator available. So you can scaffold your new project
```sh
yo kevoree
```
By doing so, `yo` should greet you and start asking some question about your project:
![yo kevoree prompt 0](http://i39.tinypic.com/idhel0.png)

The first question is about the Kevoree entity type you want to create. In our case, you want to create a new __component__.  
Then `yo` will ask for a name, in our case __FakeConsole__.  
![yo kevoree prompt 1](http://i39.tinypic.com/254y22x.png)  
And finally, `yo` will create and generate all the files needed for that project.  
![yo kevoree processing](http://i44.tinypic.com/2rx8efr.png)  

Your project should be created now and you should have a folder structure that looks like this:
![yo kevoree folder tree](http://i41.tinypic.com/25suaog.png)

### Step 3
 >  Ok, fine, `yo` created a lot of files for me. What should I do with them ? huh ?
 
Fair enough, lets describe what's what:

| Files/Folder                | Function                                                            | Tell me more!
| ----------------------------|---------------------------------------------------------------------|------------------------------------------------------------------------|
| package.json                | used by `npm` to handle you project                                 | [check this out](http://package.json.nodejitsu.com/)                   |
| kevoree-comp-fakeconsole.js | your module entry point                                             | specified in package.json by `"main": "./kevoree-comp-fakeconsole.js"` |
| node_modules/               | your module dependencies                                            | this is where all your project dependencies will be downloaded         |
| kevlib.json                 | a Kevoree model representing your entities                          | this file has been generated by `kevoree-gen-model` *|
| lib/                        | where you should put your source files (convention-ish folder name) | ... |
| lib/FakeConsole.js          | the generated skeleton of your new FakeConsole Kevoree component    | ... |

\* `kevoree-gen-model` has been added to your project dependencies by `yo kevoree`, and it will be executed each time you run `npm install` or `npm publish`.  `kevoree-gen-model` parses your files in order to find Kevoree entities and update your `kevlib.json`

### Step 4
Start your favorite editor so we can finally write some code for our component in `lib/FakeConsole.js` !  

```javascript
// if you have already created your own Component extending AbstractComponent
// you can replace AbstractComponent here and use your own
// ex: var MyComp = require('./path/to/MyComp')
// the only thing needed is that the top level component extends AbstractComponent :)
var AbstractComponent = require('kevoree-entities').AbstractComponent,
    KevoreeLogger     = require('kevoree-commons').KevoreeLogger;

/**
 * Kevoree component
 * @type {FakeConsole}
 */
var FakeConsole = AbstractComponent.extend({
  toString: 'FakeConsole',

  construct: function () {
    this.log = new KevoreeLogger(this.toString());

  },

  /**
   * this method will be called by the Kevoree platform when your component has to start
   */
  start: function () {
    // TODO
  },

  /**
   * this method will be called by the Kevoree platform when your component has to stop
   */
  stop: function () {
    // TODO
  }
});

module.exports = FakeConsole;
```

The skeleton generated by `yo kevoree` uses [PseudoClass](https://github.com/lazd/PseudoClass) to give a bit of OOP to our entities.  
With __pseudoclass__ you can easily create inheritance by calling `ParentClass.extend({/* child definition */})`, so here we have `FakeConsole` that inherits from `AbstractComponent`.  
 > __AbstractComponent__ source-code is available in [`kevoree-entities/lib/AbstractComponent`](https://github.com/dukeboard/kevoree-js/blob/master/library/kevoree-entities/lib/AbstractComponent.js)
 

##### Handle incoming messages using "Kevoree input ports":
To add an input port to a component, you just have to add a new function to your pseudoclass FakeConsole using a __predefined naming convention__:  

 * `in_XXX`: for input port
 
```javascript
var FakeConsole = AbstractComponent.extend({
  // ...

  in_inMsg: function (msg) {
    // TODO do something with incoming message
  }
});
```

So, here we have created a new input port named `inMsg`. This input port will be recognized by `kevoree-gen-model` when it will parse your code to generate a new Kevoree model for your project. (forgetting `in_` or `out_` before your port name will prevent **kevoree-gen-model** to understand that this is a port)

##### Handle message sending using "Kevoree output ports":
To add an output port to a component, you just have to add a new function to your pseudoclass FakeConsole using a __predefined naming convention__:  

 * `out_XXX`: for output port
 
```javascript
var FakeConsole = AbstractComponent.extend({
  // ...

  out_sendMsg: function () {}
});
```

So, here we have defined an output port named `sendMsg`, just by adding a new function to our pseudoclass. Pretty straightforward huh ?  
Just like our input port, `kevoree-gen-model` will be able to parse that function name and understand that we want a new __output port__ for our component because we used `out_` as a marker.

##### Well, lets test `kevoree-gen-model` and see if it is able to find those two ports!
Go back to your shell and type this in your project's root folder:
```sh
cp kevlib.json kevlib.json.bkp
npm install
diff kevlib.json kevlib.json.bkp
```

The `diff` command should give in stdo something like that:  
![new ports in model](http://i41.tinypic.com/2znn4eb.png)  
You should be able to see `required` and `provided` arrays with the name you used in your `FakeConsole.js` file.

> Wait dude, why does `npm install` launch `kevoree-gen-model` ??

Good question! If you take a closer look to `package.json` you should notice that there is a `scripts` directive with an action defined for `prepublish` events [(moar doc here!)](https://npmjs.org/doc/misc/npm-scripts.html)
```json
    "scripts": {
        "prepublish": "node node_modules/kevoree-gen-model"
    },
```
So, each time you run `npm install` or `npm publish`, this **prepublish** script should be run.  
(/!\ Seems like there is a bug in current npm version => `npm publish` do NOT trigger **prepublish** script :/)

##### TODO finish tutorial!


## Folder content

 * __kevoree-commons__: KevoreeLogger, FileSystem API, Bootstrapper, Resolver, KevoreeUI, etc.
 * __kevoree-library__: Kevoree library generated from .ecore (with KMF) and compiled to Javascript with Kotlin
 * __kevoree-entities__: Contains all abstract classes needed to create new kevoree entities (channel, component, group, etc..)
 * __kevoree-comp-__XXX, __kevoree-chan-__XXX, __kevoree-group-__XXX, etc are kevoree entity projects known as 'core libraries'